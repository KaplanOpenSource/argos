name: Deploy - create zip & upload artifact

on:
  push:
    branches:
      - main

jobs:
  build-and-archive:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # needed for `git archive`
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.16.0"
      - name: Install client dependencies
        working-directory: client
        run: npm install
      - name: Build client
        working-directory: client
        run: npm run build
      - name: Archive repository source
        run: |
          echo "Creating base archive from git HEAD"
          git archive --format=zip -o argos.zip HEAD
      - name: Record commit SHA inside the client bundle
        run: |
          mkdir -p client/dist
          git rev-parse HEAD > client/dist/commit.txt
      - name: Add built client files to the zip
        run: |
          echo "Adding client/dist/* to the archive"
          zip -ur argos.zip client/dist/*
      - name: Upload deployment artifact
        id: upload_artifact
        uses: actions/upload-artifact@v4
        with:
          name: argos-deployment
          path: argos.zip
          retention-days: 30
      - name: Show artifact download URL
        if: steps.upload_artifact.outputs.artifact-url != ''
        run: |
          echo "Artifact uploaded successfully."
          echo "Download link:"
          echo "${{ steps.upload_artifact.outputs.artifact-url }}"
